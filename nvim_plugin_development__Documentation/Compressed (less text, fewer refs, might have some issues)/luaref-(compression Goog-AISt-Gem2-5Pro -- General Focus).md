## LUA 5.1 REFERENCE FOR NEVIM PLUGIN DEVELOPMENT (Derived from `luaref.md`)

This document provides a condensed reference for Lua 5.1, tailored for Neovim plugin development, with specific relevance highlighted for the NumHi plugin project.

---

## 1. INTRODUCTION

Lua is an extension programming language designed for general procedural programming with data description facilities. It supports object-oriented, functional, and data-driven programming. It's a lightweight scripting language embedded in a host client (Neovim, in this context). Lua is dynamically typed, and all values are first-class.

---

## 2. THE LANGUAGE

This section describes the lexis, syntax, and semantics of Lua.

### 2.1 Lexical Conventions

**Keywords:**
Reserved words that cannot be used as names.

| Keyword  | Keyword  | Keyword | Keyword    | Keyword  |
| :------- | :------- | :------ | :--------- | :------- |
| `and`    | `break`  | `do`    | `else`     | `elseif` |
| `end`    | `false`  | `for`   | `function` | `if`     |
| `in`     | `local`  | `nil`   | `not`      | `or`     |
| `repeat` | `return` | `then`  | `true`     | `until`  |
| `while`  |          |         |            |          |

_NumHi Relevance_: `[NUMHI]` All keywords are fundamental for writing Lua code for the plugin.

**Identifiers (Names):**
Any string of letters, digits, and underscores, not beginning with a digit. Case-sensitive.

- Convention: `_UPPERCASE` names are reserved for internal global variables.
  _NumHi Relevance_: `[NUMHI]` Used for variables, function names, table keys in plugin code (e.g., `M.state`, `core.highlight`).

**Other Tokens:**
Operators and delimiters: `+ - * / % ^ # == ~= <= >= < > = ( ) { } [ ] ; : , . .. ...`

**Literals:**

| Literal Type                        | Syntax & Description                                                                                                                                                                                                              | Escape Sequences (Strings)                                                                                                                             | NumHi Relevance                                                                                                                                         |
| :---------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Strings**                         | Delimited by single (`'`) or double (`"`) quotes.<br>Long format: `[[...]]`, `[=[...]=]`, etc. Long format strings can span multiple lines, don't interpret escapes, and ignore other level brackets. `\ddd` for numerical value. | `\a`, `\b`, `\f`, `\n`, `\r`, `\t`, `\v`, `\\`, `\"`, `\'`. Backslash + real newline = newline in string. Can contain any 8-bit value, including `\0`. | `[NUMHI]` Used for messages, palette codes, labels, notes, file paths, keys in JSON/YAML. (e.g., `"VID"`, `"markdown"`, `"NumHi: highlight with slot"`) |
| **Numbers**                         | Real (double-precision floating-point) numbers. Optional decimal part and exponent. Hexadecimal: `0x...`. Examples: `3`, `3.0`, `3.14e-2`, `0xff`.                                                                                | N/A                                                                                                                                                    | `[NUMHI]` Used for slot numbers, color calculations, UI dimensions, loop counters. (e.g., `slot`, `width`, `height`, `1` in `cycle_palette(1)`)         |
| **Long Strings Newline Convention** | If an opening long bracket `[[` is immediately followed by a newline, the newline is not included in the string.                                                                                                                  | N/A                                                                                                                                                    | `[NUMHI]` Useful for multi-line string configurations or templates.                                                                                     |

**Comments:**

| Type          | Syntax                                                  | Description                                                              | NumHi Relevance                                                 |
| :------------ | :------------------------------------------------------ | :----------------------------------------------------------------------- | :-------------------------------------------------------------- |
| Short Comment | `-- text until end of line`                             | Ignores rest of the line.                                                | `[NUMHI]` Explaining plugin code.                               |
| Long Comment  | `--[[ text until matching ]=]` or ` --[=[ ... ]=]` etc. | Ignores block until corresponding closing bracket. Used to disable code. | `[NUMHI]` Temporarily disabling code blocks during development. |

### 2.2 Values and Types

Lua is dynamically typed. Values have types, not variables. All values are first-class.

| Type       | Description                                                                                                                                     | Truthiness                        | Key Properties / Notes                                                                                                                  | NumHi Relevance                                                                                                       |
| :--------- | :---------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------- |
| `nil`      | Represents absence of a useful value. Different from any other value.                                                                           | False                             | Variables are `nil` before first assignment. Table fields not present query as `nil`.                                                   | `[NUMHI]` Default values, checking for absence of data, error states.                                                 |
| `boolean`  | `true` or `false`.                                                                                                                              | `false` is false; `true` is true. |                                                                                                                                         | `[NUMHI]` Conditions, flags (e.g., `M.state.opts.statusline`).                                                        |
| `number`   | Double-precision floating-point numbers by default.                                                                                             | True (even 0)                     | Automatic string-to-number coercion in arithmetic ops.                                                                                  | `[NUMHI]` Slot numbers, color values, coordinates, counters.                                                          |
| `string`   | Immutable sequences of bytes. Can contain any 8-bit char, including `\0`.                                                                       | True (even `""`)                  | Automatic number-to-string coercion when string expected. Length operator `#` gives byte length.                                        | `[NUMHI]` Labels, notes, palette codes, keys, messages, file content.                                                 |
| `function` | First-class values. Can be stored in variables, passed as args, returned. Closures capture their external local variables.                      | True                              | Can be Lua functions or C functions.                                                                                                    | `[NUMHI]` Core logic of the plugin, callbacks, event handlers.                                                        |
| `userdata` | Stores arbitrary C data (raw memory). Full userdata are objects, light userdata are pointers. No predefined Lua ops except assignment/identity. | True                              | Behavior defined by metatables. Cannot be created/modified in Lua (only via C API). Used by Neovim for internal objects exposed to Lua. | `[NUMHI]` Interacting with Neovim objects (e.g., buffers, windows if exposed as userdata).                            |
| `thread`   | Represents independent threads of execution (coroutines).                                                                                       | True                              | Not OS threads. Lua coroutines are collaborative.                                                                                       | `[NUMHI]` Potentially for advanced features like S-Reader or non-blocking operations if designed that way.            |
| `table`    | Associative arrays. Can be indexed by any value (except `nil`). Heterogeneous. Sole data structuring mechanism.                                 | True                              | Objects (passed by reference). Used for arrays, records, sets, modules, objects with methods. `a.name` is sugar for `a["name"]`.        | `[NUMHI]` Central to storing plugin state, configuration, highlights, notes, palettes, UI elements. (e.g., `M.state`) |

**Coercion:**

- Automatic conversion between string and number values at run time.
- Arithmetic ops on strings try to convert to numbers.
- Numbers used where strings expected are converted to strings.
- Use `string.format()` for explicit number-to-string control.
  _NumHi Relevance_: `[NUMHI]` `tonumber()` is used for slots; string formatting for UI messages. Implicit coercion needs awareness.

### 2.3 Variables

Variables are places that store values.

| Kind        | Declaration / Access                         | Scope Rule                                           | Notes                                                                                               | NumHi Relevance                                                                                |
| :---------- | :------------------------------------------- | :--------------------------------------------------- | :-------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------- |
| Global      | `name = value` (implicit global)             | Accessible from anywhere unless shadowed.            | Stored in an environment table (`_G` by default). Avoid excessive use in plugins; prefer `local`.   | `[NUMHI]` Less common in modern plugin style; modules encapsulate state.                       |
| Local       | `local name = value`                         | Lexically scoped (from declaration to end of block). | Freely accessed by functions defined within their scope (closures/upvalues). Preferred for plugins. | `[NUMHI]` Primary way to define variables within plugin functions and modules.                 |
| Table Field | `table[key] = value` or `table.name = value` | Determined by table accessibility.                   | `key` can be any value except `nil`.                                                                | `[NUMHI]` Used extensively for plugin state (`M.state.active_palette`), options, data storage. |

- Access to a global `x` is `_env.x`.
- Access to `t[i]` can be influenced by `__index` metamethod.
- Assignment to `t[i] = val` can be influenced by `__newindex` metamethod.
  _NumHi Relevance_: `[NUMHI]` Understanding scope is crucial for plugin structure and avoiding unintended side effects.

### 2.4 Statements

Statements are executed sequentially. Optionally followed by `;`.

| Statement Type         | Syntax / Example                                                         | Description                                                                                                                                                                                               | NumHi Relevance                                                                                                              |
| :--------------------- | :----------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------- |
| **Chunk**              | `{stat [;]}`                                                             | A sequence of statements, executed sequentially. The unit of execution. Handled as body of an anonymous vararg function. Can define locals, receive args, return values.                                  | `[NUMHI]` A Lua file for a module is a chunk.                                                                                |
| **Block**              | `do block end`                                                           | A list of statements. Explicit blocks useful for controlling scope or adding `return`/`break` in the middle of another block.                                                                             | `[NUMHI]` Scoping local variables, control flow.                                                                             |
| **Assignment**         | `varlist1 = explist1` (e.g., `a, b = 1, 2` or `x, y = y, x`)             | Multiple assignment. Expressions evaluated first, then assignments. List of values adjusted to list of variables (excess thrown, `nil` for deficit). Function call as last expr provides all its returns. | `[NUMHI]` Setting variables, unpacking function results (e.g., `local l, c = unpack(vim.api.nvim_win_get_cursor(0))`).       |
| **Control Structures** |                                                                          |                                                                                                                                                                                                           |                                                                                                                              |
| `if`                   | `if exp then block {elseif exp then block} [else block] end`             | Conditional execution. `nil` and `false` are false; all else true.                                                                                                                                        | `[NUMHI]` Conditional logic throughout the plugin.                                                                           |
| `while`                | `while exp do block end`                                                 | Loop while `exp` is true.                                                                                                                                                                                 | `[NUMHI]` Looping constructs.                                                                                                |
| `repeat`               | `repeat block until exp`                                                 | Loop until `exp` is true. Block always executes at least once. Condition can access locals from block.                                                                                                    | `[NUMHI]` Looping constructs. `C.collect_digits` uses `while true do ... end` which is similar.                              |
| `for` (numeric)        | `for Name = exp1, exp2 [, exp3] do block end`                            | Iterates `Name` from `exp1` to `exp2` with step `exp3` (default 1). Control expressions evaluated once. `Name` is local to loop.                                                                          | `[NUMHI]` Iterating a known number of times (e.g., palette swatches).                                                        |
| `for` (generic)        | `for namelist in explist1 do block end`                                  | Uses an iterator function. `explist1` returns iterator func, state, initial value. Loop variables local. `pairs`, `ipairs` are common.                                                                    | `[NUMHI]` Iterating over tables (e.g., highlights, notes, palettes: `for _, pal in ipairs(State.opts.palettes) do ... end`). |
| `return`               | `return [explist1]`                                                      | Returns values from a function or chunk. Can return multiple values. Must be last statement in a block (or use `do return end`).                                                                          | `[NUMHI]` Returning values from plugin functions.                                                                            |
| `break`                | `break`                                                                  | Exits innermost `while`, `repeat`, or `for` loop. Must be last statement in a block (or use `do break end`).                                                                                              | `[NUMHI]` Exiting loops prematurely.                                                                                         |
| **Function Call**      | `functioncall` (e.g., `print("hello")`)                                  | Executes a function call as a statement; return values are discarded.                                                                                                                                     | `[NUMHI]` Calling functions for side effects (e.g., `core.highlight(num)`).                                                  |
| **Local Declaration**  | `local namelist [= explist1]` (e.g., `local x, y = 10, 20` or `local z`) | Declares local variables. Initialized to `nil` if no assignment. Scope extends to end of innermost block.                                                                                                 | `[NUMHI]` Fundamental for defining variables within functions/modules.                                                       |

### 2.5 Expressions

| Expression Type     | Basic Forms                                               | Description                                                               | NumHi Relevance                                                                                                  |
| :------------------ | :-------------------------------------------------------- | :------------------------------------------------------------------------ | :--------------------------------------------------------------------------------------------------------------- |
| Primitive           | `nil`, `false`, `true`, `Number`, `String`                | Literal values.                                                           | `[NUMHI]` Used throughout.                                                                                       |
| Variable Access     | `prefixexp` (var, function call, or `(exp)`)              | Refers to a variable's value.                                             | `[NUMHI]` Accessing plugin state, config, parameters.                                                            |
| Function Definition | `function funcbody`                                       | Creates a function value (closure).                                       | `[NUMHI]` Defining plugin logic.                                                                                 |
| Table Constructor   | `{ [fieldlist] }`                                         | Creates a new table. `{[exp1]=exp2, name=exp, exp}`.                      | `[NUMHI]` Defining palettes, state tables, configuration options. (e.g., `M.state = { active_palette = "VID" }`) |
| Vararg Expression   | `...`                                                     | Only in vararg functions. Represents extra arguments.                     | `[NUMHI]` For functions accepting variable arguments (e.g., custom `echo` or notification wrappers).             |
| Binary Operation    | `exp binop exp`                                           | Arithmetic, relational, logical, concatenation.                           | `[NUMHI]` Calculations, comparisons, string building.                                                            |
| Unary Operation     | `unop exp`                                                | Unary minus, `not`, length (`#`).                                         | `[NUMHI]` Negation, logical not, getting string/table length.                                                    |
| Function Call       | `prefixexp args` or `prefixexp : Name args` (method call) | Calls a function. Args: `([explist1])`, `tableconstructor`, or `String`.  | `[NUMHI]` Invoking plugin functions, Neovim API functions.                                                       |
| Parenthesized       | `(exp)`                                                   | Groups expression, ensures single result from multi-return function call. | `[NUMHI]` Controlling precedence or ensuring single value.                                                       |

**Operator Precedence (Lower to Higher):**

1.  `or`
2.  `and`
3.  `<  >  <=  >=  ~=  ==`
4.  `..` (string concatenation, right-associative)
5.  `+  -` (binary addition/subtraction)
6.  `*  /  %`
7.  `not  #  -` (unary operators)
8.  `^` (exponentiation, right-associative)
    _NumHi Relevance_: `[NUMHI]` Essential for writing correct complex expressions.

**Operators Details:**

| Operator Category | Operator          | Description                                                                                                                            | Notes                                                                                                                       | NumHi Relevance                                                                                                                |
| :---------------- | :---------------- | :------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------- |
| **Arithmetic**    | `+ - * / % ^`     | Usual meaning. `%` (modulo): `a % b == a - math.floor(a/b)*b`. `^` works for any exponent.                                             | Coercion applies.                                                                                                           | `[NUMHI]` Color calculations, UI positioning, slot arithmetic (`slot_to_color`).                                               |
|                   | Unary `-`         | Negation.                                                                                                                              |                                                                                                                             | `[NUMHI]`                                                                                                                      |
| **Relational**    | `== ~= < > <= >=` | Return `false` or `true`. `==`: types must be same first. Objects (tables, functions, etc.) compared by reference. `~=` is `not (==)`. | No coercion for `==`. Order ops: numbers compared numerically, strings by locale. Metamethods "eq", "lt", "le" can be used. | `[NUMHI]` Comparisons in conditional logic.                                                                                    |
| **Logical**       | `and or not`      | Consider `false` and `nil` as false, else true. `not` returns boolean. `and`/`or` use short-circuit, return one of their operands.     | `X and Y` -> `X` if `X` is false/nil, else `Y`. <br> `X or Y` -> `X` if `X` is true-ish, else `Y`.                          | `[NUMHI]` Conditional logic, default value assignment (e.g., `opts or {}`).                                                    |
| **Concatenation** | `..`              | String concatenation. Converts numbers/strings.                                                                                        | Metamethod "\_\_concat".                                                                                                    | `[NUMHI]` Building messages, file paths, formatted strings (`("NumHi %s-%d label: "):format(pal, slot)` implicitly uses this). |
| **Length**        | `#`               | String: number of bytes. Table: an integer `n` where `t[n]` is not `nil` and `t[n+1]` is `nil`. (Behavior with holes can vary).        |                                                                                                                             | `[NUMHI]` Getting length of strings, arrays (e.g., `#State.history`, `#list`).                                                 |

**Function Calls & Definitions:**

- **Function Call:** `f(a,b)`, `o:method(a,b)` (sugar for `o.method(o,a,b)`). If expression used as last in list or only element, all returns used. Else, adjusted to 1. `(f())` always one result.
- **Function Definition:** `function (params) block end`. `local function name (params) ... end`.
  - **Closures:** Functions are closures; they capture references to their surrounding local variables (upvalues).
  - **Varargs:** `function (...)` or `function (a, ...)` to accept variable arguments. Access with `...` expression. `select('#', ...)` gets count.
- **Tail Calls:** `return f()` reuses stack frame if it's the absolute last action. No limit on nested tail calls.
  _NumHi Relevance_: `[NUMHI]` Core of plugin. Closures for stateful callbacks. Varargs for flexible helper functions.

### 2.6 Visibility Rules (Lexical Scoping)

- Scope of a local variable: from statement after declaration to end of innermost block.
- Inner functions can access local variables of outer functions (these are called upvalues in the inner function).
- Each execution of a `local` statement defines new local variables.
  _NumHi Relevance_: `[NUMHI]` Critical for organizing plugin code, managing state within modules, and avoiding variable collisions.

### 2.7 Error Handling

- Errors (compilation/runtime) return control to C host (Neovim).
- `error(message [, level])`: Raises a Lua error. `level` controls error position reporting.
- `pcall(f, arg1, ...)`: Calls `f` in protected mode. Catches errors. Returns `status_ok (boolean), result1_or_err_msg, ...`.
- `xpcall(f, err_handler_func)`: Like `pcall`, but with a custom error handler function.
  _NumHi Relevance_: `[NUMHI]` `pcall` and `xpcall` are essential for robust plugin development to catch errors gracefully (e.g., when requiring optional dependencies, handling user input, I/O). `error()` for signaling plugin-specific errors.

### 2.8 Metatables

Ordinary Lua tables that define behavior for other values (tables or userdata) under certain operations.

- `getmetatable(value)`: Returns metatable or `nil`. If metatable has `__metatable` field, returns that field's value.
- `setmetatable(table, metatable_or_nil)`: Sets or removes metatable. Can't change metatables of other types from Lua (except via debug library).

**Metamethods (Events are keys like `__add`):**

| Event         | Operator/Operation Trigger                                                       | Description of Metamethod `h(op1, op2)` or `h(op)`                                                                         | NumHi Relevance                                                                                                                                                                                                                         |
| :------------ | :------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `__add`       | `+`                                                                              | `h(op1, op2)` for addition.                                                                                                | `[NUMHI]` Potentially for custom data types if plugin needs complex arithmetic.                                                                                                                                                         |
| `__sub`       | `-`                                                                              | `h(op1, op2)` for subtraction.                                                                                             |                                                                                                                                                                                                                                         |
| `__mul`       | `*`                                                                              | `h(op1, op2)` for multiplication.                                                                                          |                                                                                                                                                                                                                                         |
| `__div`       | `/`                                                                              | `h(op1, op2)` for division.                                                                                                |                                                                                                                                                                                                                                         |
| `__mod`       | `%`                                                                              | `h(op1, op2)` for modulo.                                                                                                  |                                                                                                                                                                                                                                         |
| `__pow`       | `^`                                                                              | `h(op1, op2)` for exponentiation.                                                                                          |                                                                                                                                                                                                                                         |
| `__unm`       | Unary `-`                                                                        | `h(op)` for negation.                                                                                                      |                                                                                                                                                                                                                                         |
| `__concat`    | `..`                                                                             | `h(op1, op2)` for concatenation.                                                                                           | `[NUMHI]` Could customize string representation of plugin objects.                                                                                                                                                                      |
| `__len`       | `#`                                                                              | `h(op)` for length.                                                                                                        | `[NUMHI]` Customize how `#` works on custom table structures.                                                                                                                                                                           |
| `__eq`        | `==`                                                                             | `h(op1, op2)` for equality. Called if `op1` and `op2` are same type and share this metamethod. `a ~= b` is `not (a == b)`. | `[NUMHI]` Custom equality for complex data structures.                                                                                                                                                                                  |
| `__lt`        | `<`                                                                              | `h(op1, op2)` for less than. `a > b` is `b < a`.                                                                           | `[NUMHI]` Custom sorting for lists of highlights/notes.                                                                                                                                                                                 |
| `__le`        | `<=`                                                                             | `h(op1, op2)` for less than or equal. If no `__le`, tries `__lt` (`not h(op2, op1)`). `a >= b` is `b <= a`.                | `[NUMHI]` Custom sorting.                                                                                                                                                                                                               |
| `__index`     | `table[key]` (when `key` not in `table`)                                         | If `h` is function: `h(table, key)`. If `h` is table: `h[key]` (repeats lookup on `h`).                                    | `[NUMHI]` Very useful for default values in config tables, implementing inheritance-like behavior, or dynamic property lookup. Example: `setmetatable(M.state, {__index = default_opts})`.                                              |
| `__newindex`  | `table[key] = value` (when `key` not in `table`, or rawset would apply to `nil`) | If `h` is function: `h(table, key, value)`. If `h` is table: `h[key] = value` (assignment on `h`).                         | `[NUMHI]` Intercepting/validating assignments to tables, dynamic property setting.                                                                                                                                                      |
| `__call`      | `value(...)` (when `value` is not a function)                                    | `h(value, ...)` to make a non-function value callable.                                                                     | `[NUMHI]` Could make plugin state tables callable for a default action.                                                                                                                                                                 |
| `__tostring`  | `tostring(value)`                                                                | `h(value)` for custom string representation. Used by `print`.                                                              | `[NUMHI]` Custom string representation for debugging or displaying plugin's internal data structures.                                                                                                                                   |
| `__metatable` | `getmetatable(value)`                                                            | If this field exists in a metatable, `getmetatable` returns its value instead of the metatable itself. Protects metatable. | `[NUMHI]` Can protect plugin's internal metatables.                                                                                                                                                                                     |
| `__gc`        | Garbage collection of userdata                                                   | `h(userdata)` called when userdata with this metamethod is about to be collected. For finalization.                        | `[NUMHI]` Relevant if plugin uses custom C userdata via FFI or external libs that need cleanup. Less common for pure Lua plugins.                                                                                                       |
| `__mode`      | Weak tables (used in metatable)                                                  | String: "k" for weak keys, "v" for weak values, "kv" for both. Weak references don't prevent GC.                           | `[NUMHI]` Useful for caching or managing large datasets where objects should be collectible if not referenced elsewhere. Might be relevant for managing extmark data if it becomes very large and needs to be GC'd with buffer closure. |

### 2.9 Environments

Tables associated with threads, functions, and userdata.

- `getfenv(f_or_level)`: Gets environment of function `f` or at stack level. Default for `f` is 1 (caller). Level 0 or non-Lua function gives global env.
- `setfenv(f_or_level, table)`: Sets environment. Level 0 changes running thread's env.
- Global variables are resolved by looking them up in the function's environment table.
  _NumHi Relevance_: `[NUMHI]` Less commonly manipulated directly in modern Lua module patterns, which favor lexical scoping. `_G` is the default global environment. Understanding helps with `loadstring` or dynamic code execution contexts.

### 2.10 Garbage Collection (GC)

Automatic memory management for all Lua objects. Incremental mark-and-sweep.

- `collectgarbage(opt [, arg])`: Interface to GC.
  - `"collect"`: full cycle.
  - `"stop"`/`"restart"`: control collector.
  - `"count"`: memory in Kbytes.
  - `"step"`: incremental step.
  - `"setpause"`/`"setstepmul"`: tune GC.
- Finalizers (`__gc` metamethod for userdata).
- Weak Tables (`__mode` field in metatable: "k", "v", "kv").
  _NumHi Relevance_: `[NUMHI]` Mostly automatic. Weak tables could be useful for managing large, temporary data associated with buffers or highlights that should be cleaned up if the buffer is closed or highlights are removed.

### 2.11 Coroutines (Collaborative Multithreading)

Independent threads of execution that yield explicitly.

| Coroutine Function          | Syntax / Parameters                                | Description                                                                                                                  | Returns (for `resume`)                                                                        | NumHi Relevance                                                                      |
| :-------------------------- | :------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------- |
| `coroutine.create(f)`       | `f`: Lua function (coroutine body)                 | Creates a new coroutine with body `f`. Returns thread object. Does not start it.                                             | Thread object                                                                                 | `[NUMHI]` Potential for non-blocking tasks, S-Reader, complex UI interactions.       |
| `coroutine.resume(co, ...)` | `co`: thread object, `...`: args to `f` or `yield` | Starts or resumes coroutine `co`. Args passed to `f` on first resume, or as return from `yield` on subsequent.               | `true, ...` (values from `yield` or `f`'s return) on success. <br> `false, err_msg` on error. | `[NUMHI]` To run and pass data to coroutines.                                        |
| `coroutine.yield(...)`      | `...`: values to return from `resume`              | Suspends calling coroutine. Values passed to `yield` are returned by `coroutine.resume`.                                     | (Returns values passed to next `coroutine.resume`)                                            | `[NUMHI]` To pause a coroutine and return control/data.                              |
| `coroutine.status(co)`      | `co`: thread object                                | Returns status string: "running", "suspended", "normal", "dead".                                                             | Status string                                                                                 | `[NUMHI]` Checking coroutine state.                                                  |
| `coroutine.wrap(f)`         | `f`: Lua function (coroutine body)                 | Creates coroutine, returns a function that resumes it on each call. Args to wrapper are args to `resume`. Propagates errors. | Wrapper function. On call, returns values from `resume` (except first boolean).               | `[NUMHI]` Convenient way to use coroutines like iterators or resumable computations. |
| `coroutine.running()`       |                                                    | Returns the running coroutine or `nil` if called by main thread.                                                             | Running thread object or `nil`.                                                               | `[NUMHI]` Identifying current coroutine.                                             |

---

## 3. THE APPLICATION PROGRAM INTERFACE (C API)

This section describes the C API for Lua. While Neovim plugin developers primarily use Lua, understanding these concepts can be helpful for grasping how Lua interacts with the C-based Neovim core and how `vim.api` functions might be designed or behave.

**Key Concepts:**

- **Stack (`lua_State *L`)**: Lua uses a virtual stack to pass values to/from C. Indices can be positive (from bottom, 1-based) or negative (from top, -1 is top).
- **Stack Management**: C functions are responsible for stack consistency (`lua_checkstack`).
- **Pseudo-Indices**: Special indices for registry (`LUA_REGISTRYINDEX`), environment (`LUA_GLOBALSINDEX`, `LUA_ENVIRONINDEX`), upvalues.
- **C Closures**: C functions can have associated Lua values (upvalues).
- **Registry**: A pre-defined table at `LUA_REGISTRYINDEX` for C code to store Lua values. `luaL_ref` and `luaL_unref` use integer keys here.
- **Error Handling**: Lua uses `longjmp` internally. `lua_error` raises an error from C. `lua_pcall` calls Lua functions in protected mode.

**Selected C API Functions (Conceptual Relevance for Lua Scripters):**

| C API Function (Conceptual)                                       | Description (Conceptual Parallel in Lua/Nvim)                            | NumHi Relevance (Conceptual)                                                                                                          |
| :---------------------------------------------------------------- | :----------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------ |
| `lua_call / lua_pcall`                                            | Calling Lua functions from C. `lua_pcall` includes error handling.       | `[NUMHI]` Analogous to Lua's `pcall()` for safe function execution. `vim.api` calls are C functions called from Lua.                  |
| `lua_CFunction`                                                   | Protocol for C functions callable by Lua (stack usage for args/results). | Understanding how Neovim API functions (`vim.api.*`) receive arguments from Lua and return results.                                   |
| `lua_checkstack`                                                  | Ensuring stack space.                                                    | Lua in Neovim handles this, but be mindful of very deep recursion or huge data on stack.                                              |
| `lua_tostring / lua_tonumber / lua_toboolean`                     | Converting Lua values on stack to C types.                               | `[NUMHI]` Analogous to Lua's `tostring()`, `tonumber()`, and boolean evaluation rules.                                                |
| `lua_pushstring / lua_pushnumber / lua_pushnil / lua_pushboolean` | Pushing C values onto Lua stack.                                         | How Lua values are created/passed to Neovim API functions.                                                                            |
| `lua_istable / lua_isfunction / etc.`                             | Type checking values on stack.                                           | `[NUMHI]` Analogous to Lua's `type() == "table"`. `vim.api` functions often expect specific types.                                    |
| `lua_getglobal / lua_setglobal`                                   | Accessing global Lua variables from C.                                   | Generally discouraged in modern Lua. Modules are preferred.                                                                           |
| `lua_getfield / lua_setfield`                                     | Accessing table fields by string key from C.                             | `[NUMHI]` Similar to `table.key` or `table["key"]` in Lua.                                                                            |
| `lua_gettable / lua_settable`                                     | Accessing table fields by Lua value key from C (key is on stack).        | `[NUMHI]` Similar to `table[key_expression]` in Lua.                                                                                  |
| `lua_rawget / lua_rawset`                                         | Table access without invoking metamethods.                               | `[NUMHI]` Analogous to Lua's `rawget()` and `rawset()`.                                                                               |
| `lua_createtable / lua_newuserdata`                               | Creating Lua objects from C.                                             | Neovim creates objects (buffers, windows) exposed to Lua, often as userdata.                                                          |
| `lua_getmetatable / lua_setmetatable`                             | Manipulating metatables from C.                                          | `[NUMHI]` Analogous to Lua's `getmetatable()` and `setmetatable()`.                                                                   |
| `lua_load / lua_dump`                                             | Loading/dumping Lua chunks (binary or text).                             | `[NUMHI]` Analogous to Lua's `loadstring()`, `loadfile()`, `string.dump()`. Could be used for dynamic code loading or precompilation. |
| `lua_newthread / lua_resume / lua_yield`                          | Coroutine manipulation from C.                                           | `[NUMHI]` Conceptual basis for Lua's `coroutine` library.                                                                             |
| `lua_error`                                                       | Raising a Lua error from C.                                              | Analogous to Lua's `error()`. How Neovim API might signal errors.                                                                     |

**Debug Interface (C API - `lua_Debug`, `lua_getinfo`, etc.):**

- Provides programmatic access to call stack, local variables, upvalues, hooks.
- Basis for Lua's `debug` library.
  _NumHi Relevance_: `[NUMHI]` Understanding this helps when using the `debug` library for plugin development/troubleshooting.

---

## 4. THE AUXILIARY LIBRARY (`lauxlib.h`)

Provides higher-level functions for common C-Lua interaction tasks, built on the basic C API. Prefix `luaL_`.

| `luaL_*` Function        | Description (Main Purpose)                                                                                                                           | NumHi Relevance (Conceptual or for advanced use)                                                                                                                                                                                                       |
| :----------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- | ---------------------------------------------------- |
| `luaL_check*` family     | e.g., `luaL_checkstring`, `luaL_checknumber`, `luaL_checktype`, `luaL_checkudata`. Checks function argument types and raises an error if mismatched. | `[NUMHI]` Good practice for validating arguments passed to plugin functions, similar to manual type checks in Lua. `vim.api` functions often perform similar checks internally.                                                                        |
| `luaL_opt*` family       | e.g., `luaL_optstring`. Checks argument type or provides a default if absent/`nil`.                                                                  | `[NUMHI]` Useful pattern for optional function arguments in plugins. (e.g., `local my_opt = opts.my_opt or "default_value"`)                                                                                                                           |
| `luaL_argerror`          | Raises a standard argument error.                                                                                                                    | `[NUMHI]` Helper for reporting errors related to function arguments.                                                                                                                                                                                   |
| `luaL_Buffer` operations | `luaL_buffinit`, `luaL_addchar`, `luaL_addlstring`, `luaL_addvalue`, `luaL_pushresult`. Efficiently build Lua strings piecemeal in C.                | `[NUMHI]` Conceptually similar to using `table.concat` with a list of strings in Lua for efficient string building, which is often needed for generating export content or large UI messages.                                                          |
| `luaL_loadfile`          | Loads a file as a Lua chunk (uses `lua_load`). Handles file opening.                                                                                 | `[NUMHI]` Analogous to Lua's `loadfile()`. For loading configuration or script files.                                                                                                                                                                  |
| `luaL_loadstring`        | Loads a string as a Lua chunk.                                                                                                                       | `[NUMHI]` This is Lua's `loadstring()`.                                                                                                                                                                                                                |
| `luaL_loadbuffer`        | Loads from a memory buffer.                                                                                                                          | `[NUMHI]` Similar to `loadstring` if the string is already in memory.                                                                                                                                                                                  |
| `luaL_dofile`            | Loads and runs a file. (Macro: `luaL_loadfile                                                                                                        |                                                                                                                                                                                                                                                        | lua_pcall`) | `[NUMHI]` This is Lua's `dofile()`.                  |
| `luaL_dostring`          | Loads and runs a string. (Macro: `luaL_loadstring                                                                                                    |                                                                                                                                                                                                                                                        | lua_pcall`) | `[NUMHI]` Equivalent to `assert(loadstring(str))()`. |
| `luaL_error`             | Raises an error with formatted message, including file/line info.                                                                                    | `[NUMHI]` This is Lua's `error()`.                                                                                                                                                                                                                     |
| `luaL_newmetatable`      | Creates a new metatable in registry (if not exists) for userdata type `tname`.                                                                       | `[NUMHI]` Neovim uses a similar mechanism for type metatables of its objects. Plugins might use it for FFI-created userdata.                                                                                                                           |
| `luaL_getmetatable`      | Pushes metatable associated with `tname` from registry.                                                                                              | `[NUMHI]` Retrieving shared metatables.                                                                                                                                                                                                                |
| `luaL_getmetafield`      | Gets field `e` from metatable of object `obj`.                                                                                                       | `[NUMHI]` Useful for checking if a metamethod exists before calling it.                                                                                                                                                                                |
| `luaL_callmeta`          | Calls metamethod `e` on object `obj`.                                                                                                                | `[NUMHI]` Programmatic way to invoke a metamethod.                                                                                                                                                                                                     |
| `luaL_ref`               | Creates an integer reference in table `t` for object on stack top (pops object). Returns ref ID. `LUA_REFNIL`, `LUA_NOREF`.                          | `[NUMHI]` Useful for storing Lua callbacks or data in Lua from C side, ensuring they are not garbage collected. Neovim uses this internally (e.g., for autocmd callbacks). Plugins can use it if they need to manage Lua function references robustly. |
| `luaL_unref`             | Releases a reference created by `luaL_ref`.                                                                                                          | `[NUMHI]` Paired with `luaL_ref` to manage lifecycle.                                                                                                                                                                                                  |
| `luaL_register`          | Opens a library (registers C functions into a table).                                                                                                | `[NUMHI]` This is how standard Lua libraries and C-based Lua modules are typically structured and loaded. `require` uses this pattern for C modules.                                                                                                   |
| `luaL_gsub`              | String replacement, similar to `string.gsub`.                                                                                                        | `[NUMHI]` String manipulation utility.                                                                                                                                                                                                                 |
| `luaL_where`             | Pushes string identifying current code position (e.g., `chunkname:line:`).                                                                           | `[NUMHI]` Helpful for constructing detailed error messages. `debug.traceback` uses this.                                                                                                                                                               |
| `luaL_newstate`          | Creates a new Lua state with standard allocator and panic function.                                                                                  | Not directly used by plugin authors, as Neovim provides the Lua state.                                                                                                                                                                                 |
| `luaL_openlibs`          | Opens all standard Lua libraries.                                                                                                                    | Neovim does this. Plugin authors use the libraries directly.                                                                                                                                                                                           |

---

## 5. STANDARD LIBRARIES

Standard libraries provide essential functions. Neovim preloads these.

### 5.1 Basic Functions (`_G` and global functions)

Core Lua functions, many available globally.

| Function / Variable             | Syntax / Parameters                                  | Description & Key Behavior                                                                                                                                                                                 | Returns                                                      | NumHi Relevance                                                                                                                                                                                                                        |
| :------------------------------ | :--------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `assert(v [, msg])`             | `v`: value, `msg` (optional): string                 | If `v` is `false` or `nil`, raises error with `msg` (default "assertion failed!"). Else, returns all arguments.                                                                                            | Arguments (if `v` is true-ish)                               | `[NUMHI]` For preconditions, invariants. Useful for debugging and ensuring state.                                                                                                                                                      |
| `collectgarbage(opt [, arg])`   | `opt`: string, `arg` (optional)                      | GC interface. Options: "stop", "restart", "collect", "count" (Kbytes), "step", "setpause" (arg/100), "setstepmul" (arg/100).                                                                               | Varies by `opt` (e.g., memory count, boolean for step).      | `[NUMHI]` Rarely needed directly; GC is automatic.                                                                                                                                                                                     |
| `dofile(filename)`              | `filename` (optional): string                        | Opens file, executes as Lua chunk. No args: uses stdin. Propagates errors.                                                                                                                                 | Values returned by chunk.                                    | `[NUMHI]` For loading external Lua script files (e.g., user configurations, themes) if not using `require`.                                                                                                                            |
| `error(msg [, level])`          | `msg`: string, `level` (optional): number            | Terminates last protected call, returns `msg`. `level`: 1 (default) error at `error` call, 2 at `error`'s caller, etc. 0 avoids adding position. Never returns.                                            | (Does not return)                                            | `[NUMHI]` Signaling fatal plugin errors. (e.g., `core.lua` uses it in an early example, `luaL_error` is the C equivalent).                                                                                                             |
| `_G`                            | (Global variable)                                    | Holds the global environment table (`_G._G == _G`).                                                                                                                                                        | The global table.                                            | `[NUMHI]` Accessing global environment if necessary, but generally avoided in module-based plugins.                                                                                                                                    |
| `getfenv(f_or_level)`           | `f_or_level` (optional): function or number          | Returns environment of func `f` or at stack `level`. Default 1 (caller). Level 0 or non-Lua func: global env.                                                                                              | Environment table.                                           | `[NUMHI]` Rarely used; lexical scoping and modules are preferred.                                                                                                                                                                      |
| `getmetatable(obj)`             | `obj`: any value                                     | If `obj` has no metatable, returns `nil`. If metatable has `__metatable` field, returns its value. Else, returns `obj`'s metatable.                                                                        | Metatable or `nil` or `__metatable` field value.             | `[NUMHI]` Inspecting or retrieving metatables, e.g., for custom object behavior or type checking.                                                                                                                                      |
| `ipairs(t)`                     | `t`: table                                           | Iterator for numeric keys 1 to `n` in a table. `for i,v in ipairs(t) do ... end`.                                                                                                                          | Iterator function, table `t`, 0.                             | `[NUMHI]` Iterating over array-like tables in sequence (e.g., list of palettes, ordered notes). `init.lua` uses `for _, f in ipairs({...})`.                                                                                           |
| `load(func [, chunkname])`      | `func`: function (reader), `chunkname` (opt): string | Loads chunk using `func` to get pieces (string or `nil` for EOF). Returns compiled chunk or `nil`+err. Env is global.                                                                                      | Function (chunk) or `nil`, error message.                    | `[NUMHI]` Dynamic code loading if needed.                                                                                                                                                                                              |
| `loadfile(filename)`            | `filename` (optional): string                        | Loads chunk from `filename` (or stdin). Returns compiled chunk or `nil`+err. Env is global.                                                                                                                | Function (chunk) or `nil`, error message.                    | `[NUMHI]` Loading Lua code from files.                                                                                                                                                                                                 |
| `loadstring(str [, chunkname])` | `str`: string, `chunkname` (optional): string        | Loads chunk from `str`. Returns compiled chunk or `nil`+err. Env is global. `assert(loadstring(s))()` to load & run.                                                                                       | Function (chunk) or `nil`, error message.                    | `[NUMHI]` Executing dynamically generated Lua code, or code from strings (e.g., user-provided snippets for templates - carefully!).                                                                                                    |
| `next(t [, index])`             | `t`: table, `index` (optional): any key              | Traverses table. `index=nil` or absent: gets first pair. Else: gets pair after `index`. No more elements: `nil`. Order not guaranteed for numeric keys. Don't modify non-existent fields during traversal. | Next key, next value (or `nil`).                             | `[NUMHI]` General table iteration if `pairs`/`ipairs` don't fit (e.g., tables with mixed key types, sparse arrays).                                                                                                                    |
| `pairs(t)`                      | `t`: table                                           | Iterator for all key-value pairs in `t` (uses `next`). `for k,v in pairs(t) do ... end`.                                                                                                                   | `next` function, table `t`, `nil`.                           | `[NUMHI]` Iterating over all entries in a table, including non-numeric keys (e.g., highlight properties, label storage `State.labels[pal]`). `core.lua` implicitly uses this pattern when iterating `ns_ids` or `State.opts.palettes`. |
| `pcall(f, arg1, ...)`           | `f`: function, `arg1,...`: arguments to `f`          | Protected call. `true, results...` on success. `false, err_msg` on error.                                                                                                                                  | `status_ok` (boolean), results or error message.             | `[NUMHI]` Crucial for safe execution of code that might fail (e.g., I/O, optional module loading, callbacks). `init.lua` uses it for `require`.                                                                                        |
| `print(...)`                    | `...`: any arguments                                 | Prints args to stdout, converted by `tostring`. For quick debug, not formatted output.                                                                                                                     | (None)                                                       | `[NUMHI]` Debugging during development. `core.lua` uses `print` for "No NumHi highlight under cursor".                                                                                                                                 |
| `rawequal(v1, v2)`              | `v1, v2`: any values                                 | Checks `v1 == v2` without metamethods.                                                                                                                                                                     | Boolean.                                                     | `[NUMHI]` If precise, non-meta-influenced equality is needed.                                                                                                                                                                          |
| `rawget(t, index)`              | `t`: table, `index`: any key                         | Gets `t[index]` without `__index` metamethod.                                                                                                                                                              | Value or `nil`.                                              | `[NUMHI]` Accessing table elements bypassing metatables, e.g., when metatable implements defaults.                                                                                                                                     |
| `rawset(t, index, val)`         | `t`: table, `index`: key (not `nil`), `val`: any     | Sets `t[index] = val` without `__newindex` metamethod.                                                                                                                                                     | Table `t`.                                                   | `[NUMHI]` Setting table elements bypassing metatables.                                                                                                                                                                                 |
| `select(idx, ...)`              | `idx`: number or `"#"`, `...`: varargs               | If `idx` is number: returns args from `idx`. If `idx` is `"#"`: returns total number of varargs.                                                                                                           | Selected arguments or count.                                 | `[NUMHI]` Manipulating varargs.                                                                                                                                                                                                        |
| `setfenv(f_or_level, table)`    | `f_or_level`: func or number, `table`: env table     | Sets environment for function `f` or at `level`. Level 0: current thread.                                                                                                                                  | Function `f` (or no value if level 0).                       | `[NUMHI]` Rarely used.                                                                                                                                                                                                                 |
| `setmetatable(t, mt)`           | `t`: table, `mt`: metatable or `nil`                 | Sets/removes metatable for `t`. Error if original metatable has `__metatable` field.                                                                                                                       | Table `t`.                                                   | `[NUMHI]` Attaching custom behavior to tables (e.g., default values for config, custom object methods).                                                                                                                                |
| `tonumber(e [, base])`          | `e`: string or number, `base` (optional): 2-36       | Converts `e` to number. Returns number or `nil`. `base` for non-decimal. Base 10 can have decimal part/exponent.                                                                                           | Number or `nil`.                                             | `[NUMHI]` Converting string input (e.g., slot numbers) to numbers. Used in `core.lua` for slot.                                                                                                                                        |
| `tostring(e)`                   | `e`: any value                                       | Converts `e` to string. Calls `__tostring` metamethod if present.                                                                                                                                          | String.                                                      | `[NUMHI]` Converting values to strings for display, messages, keys. `init.lua` uses `tostring(n)` for statusline.                                                                                                                      |
| `type(v)`                       | `v`: any value                                       | Returns type of `v` as a string: "nil", "number", "string", "boolean", "table", "function", "thread", "userdata".                                                                                          | Type string.                                                 | `[NUMHI]` Type checking values, conditional logic based on type.                                                                                                                                                                       |
| `unpack(list [, i [, j]])`      | `list`: table, `i` (opt): number, `j` (opt): number  | Returns elements `list[i]` to `list[j]`. Default `i=1, j=#list`. (In Lua 5.1, this is `unpack`. In Lua 5.2+ it's `table.unpack`).                                                                          | Elements `list[i]...list[j]`.                                | `[NUMHI]` Returning multiple values from an array-like table. `core.lua` uses `unpack` (or `table.unpack` alias) for `vim.api.nvim_win_get_cursor` and `hsluv.hex_to_hsluv`.                                                           |
| `_VERSION`                      | (Global variable)                                    | String with Lua interpreter version (e.g., "Lua 5.1").                                                                                                                                                     | Version string.                                              | `[NUMHI]` Checking Lua version if plugin needs version-specific logic (rare for 5.1 focus).                                                                                                                                            |
| `xpcall(f, err_handler)`        | `f`: function, `err_handler`: error handler function | Like `pcall`, but with custom `err_handler` function called on error.                                                                                                                                      | `status_ok` (boolean), results or result from `err_handler`. | `[NUMHI]` More controlled error handling than `pcall`.                                                                                                                                                                                 |

### 5.2 Coroutine Manipulation (`coroutine` table)

(Already detailed in Language Section 2.11; listed here for library structure completeness)

| Function                    | See Section 2.11 for details                             | NumHi Relevance                                                            |
| :-------------------------- | :------------------------------------------------------- | :------------------------------------------------------------------------- |
| `coroutine.create(f)`       | Creates a new coroutine.                                 | `[NUMHI]` Potential for S-Reader, complex UI updates, or background tasks. |
| `coroutine.resume(co, ...)` | Starts or continues a coroutine.                         | `[NUMHI]`                                                                  |
| `coroutine.running()`       | Returns the running coroutine.                           | `[NUMHI]`                                                                  |
| `coroutine.status(co)`      | Returns the status of a coroutine.                       | `[NUMHI]`                                                                  |
| `coroutine.wrap(f)`         | Creates a coroutine and returns a function to resume it. | `[NUMHI]`                                                                  |
| `coroutine.yield(...)`      | Suspends the coroutine.                                  | `[NUMHI]`                                                                  |

### 5.3 Modules (`package` table and `module`, `require` global functions)

Provides facilities for loading and structuring modules.

| Function / Variable                  | Syntax / Parameters                     | Description & Key Behavior                                                                                                                                                                                                                                     | NumHi Relevance                                                                                                                                                              |
| :----------------------------------- | :-------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `require(modname)`                   | `modname`: string                       | Loads module. Checks `package.loaded`. If not found, searches `package.preload`, then `package.path` (Lua loaders), then `package.cpath` (C loaders), then all-in-one C loader. Stores result in `package.loaded[modname]`. Returns `package.loaded[modname]`. | `[NUMHI]` Fundamental for structuring plugin into multiple files (`require("numhi.core")`, `require("hsluv")`).                                                              |
| `module(name [, ...])`               | `name`: string, `...`: option functions | Creates/reuses a module table. Sets `_NAME`, `_M`, `_PACKAGE`. Sets module table as current env and `package.loaded[name]`. Options (functions) applied to module. Deprecated in favor of returning a table from module file.                                  | `[NUMHI]` Older style of module creation. Modern Neovim plugins usually define a local table `M` and return `M` at the end of the module file, which `require` then handles. |
| `package.path`                       | (String variable)                       | Semicolon-separated path templates for Lua loaders. `?` replaced by module name (dots to dir separators). Initialized from `LUA_PATH` env var or default.                                                                                                      | `[NUMHI]` How Neovim finds Lua modules. Plugin managers often manipulate `runtimepath` which influences this.                                                                |
| `package.cpath`                      | (String variable)                       | Semicolon-separated path templates for C loaders. Initialized from `LUA_CPATH` env var or default.                                                                                                                                                             | `[NUMHI]` For C modules, if any are used by the plugin (e.g. via FFI or precompiled).                                                                                        |
| `package.loaded`                     | (Table variable)                        | Cache of loaded modules. `require` checks here first. Key is module name, value is what the module returned.                                                                                                                                                   | `[NUMHI]` `require` interacts with this. Can be inspected for debugging module loading.                                                                                      |
| `package.preload`                    | (Table variable)                        | Stores custom loader functions for specific modules. `require` checks here before path searching. Key is module name, value is loader function.                                                                                                                | `[NUMHI]` Can be used to define custom loading logic for certain modules if needed.                                                                                          |
| `package.loadlib(libname, funcname)` | `libname`: string, `funcname`: string   | Low-level dynamic linking of C library `libname` and retrieves C function `funcname`. Bypasses `require`'s path searching. Platform-dependent.                                                                                                                 | `[NUMHI]` For advanced use cases involving direct loading of C libraries not managed by `require`'s standard mechanism.                                                      |
| `package.seeall(module_table)`       | `module_table`: table                   | Sets metatable for `module_table` with `__index` field pointing to global env. Used as an option to `module()`. Allows module to access globals directly. Deprecated pattern.                                                                                  | `[NUMHI]` Avoid; explicit `require` or passing dependencies is better.                                                                                                       |

### 5.4 String Manipulation (`string` table)

Functions for string operations. Strings are 1-indexed. Negative indices count from end (-1 is last char).

| Function                                     | Syntax / Parameters                                                 | Description & Key Behavior                                                                                                                                                            | Returns                                        | NumHi Relevance                                                                                                                            |
| :------------------------------------------- | :------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :--------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------- |
| `string.byte(s [, i [, j]])`                 | `s`: string, `i,j` (opt): numbers                                   | Returns internal numerical codes of chars `s[i]` to `s[j]`. Default `i=1, j=i`.                                                                                                       | Numerical codes (one or more).                 | `[NUMHI]` Character code manipulation if needed (e.g., for specific encoding tasks, rare).                                                 |
| `string.char(...)`                           | `...`: numbers (char codes)                                         | Returns string from numerical codes.                                                                                                                                                  | String.                                        | `[NUMHI]` Creating strings from char codes (rare).                                                                                         |
| `string.dump(func)`                          | `func`: Lua function                                                | Returns binary representation of `func` (no upvalues). Can be loaded via `loadstring`.                                                                                                | Binary string.                                 | `[NUMHI]` Precompiling Lua code, or serializing functions without upvalues.                                                                |
| `string.find(s, pattern [, init [, plain]])` | `s, pattern`: strings, `init` (opt): number, `plain` (opt): bool    | Finds first match of `pattern` in `s`. `init`: start pos (default 1). `plain`: no magic chars.                                                                                        | `start_idx, end_idx [, captures...]` or `nil`. | `[NUMHI]` Searching for substrings or patterns in notes, labels, configuration strings.                                                    |
| `string.format(fmtstr, ...)`                 | `fmtstr`: string, `...`: values                                     | Formats string like C `sprintf`. Options: `%s` (string), `%d` (int), `%f` (num), `%c` (char), `%q` (escaped Lua string), `%%` (literal %). No `*`, `l`, `L`, `n`, `p`, `h` modifiers. | Formatted string.                              | `[NUMHI]` Essential for creating UI messages, export content, status line text. (e.g., `("NumHi %s-%d"):format(pal, slot)` in `core.lua`). |
| `string.gmatch(s, pattern)`                  | `s, pattern`: strings                                               | Iterator for captures of `pattern` in `s`. If no captures, whole match.                                                                                                               | Iterator function.                             | `[NUMHI]` Iterating over all matches of a pattern (e.g., extracting all tags `#tag` from a note, as in `C.edit_note`).                     |
| `string.gsub(s, pat, repl [, n])`            | `s, pat`: strings, `repl`: string/table/function, `n` (opt): number | Replaces occurrences of `pat` in `s` with `repl`. `repl` string: `%N` for captures. `repl` table: uses 1st capture as key. `repl` func: called with captures. `n`: max replacements.  | New string, number of substitutions.           | `[NUMHI]` Powerful text replacement for formatting notes, generating export, sanitizing input.                                             |
| `string.len(s)`                              | `s`: string                                                         | Returns length of `s` in bytes. (Same as `#s`).                                                                                                                                       | Number.                                        | `[NUMHI]` Getting string lengths for UI calculations, validation.                                                                          |
| `string.lower(s)`                            | `s`: string                                                         | Converts `s` to lowercase (locale-dependent).                                                                                                                                         | Lowercase string.                              | `[NUMHI]` Case-insensitive comparisons or normalization of tags/labels.                                                                    |
| `string.match(s, pattern [, init])`          | `s, pattern`: strings, `init` (opt): number                         | Finds first match of `pattern` in `s`. `init`: start pos (default 1).                                                                                                                 | Captures or whole match, or `nil`.             | `[NUMHI]` Extracting specific parts of a string based on a pattern (e.g., `hl_group:match("_(%d+)$")` in `core.lua`).                      |
| `string.rep(s, n)`                           | `s`: string, `n`: number                                            | Returns string `s` repeated `n` times.                                                                                                                                                | Repeated string.                               | `[NUMHI]` Generating repeated characters/strings for UI formatting (e.g., padding).                                                        |
| `string.reverse(s)`                          | `s`: string                                                         | Reverses `s`.                                                                                                                                                                         | Reversed string.                               | `[NUMHI]` Rarely needed for typical plugin tasks.                                                                                          |
| `string.sub(s, i [, j])`                     | `s`: string, `i,j`: numbers                                         | Substring from `i` to `j`. Default `j=-1` (to end).                                                                                                                                   | Substring.                                     | `[NUMHI]` Extracting parts of strings (e.g., `hex:sub(1,2)` in `core.lua`'s `contrast_fg`).                                                |
| `string.upper(s)`                            | `s`: string                                                         | Converts `s` to uppercase (locale-dependent).                                                                                                                                         | Uppercase string.                              | `[NUMHI]` Case-insensitive comparisons or normalization.                                                                                   |

**String Patterns:**
Lua patterns are not full regular expressions but offer powerful matching.

- **Character Classes:**
  - `.` (all chars), `%a` (letters), `%c` (control), `%d` (digits), `%l` (lowercase), `%p` (punctuation), `%s` (space), `%u` (uppercase), `%w` (alphanumeric), `%x` (hex digits), `%z` (char `\0`).
  - `%X` (complement of `%x`, e.g., `%S` is non-space).
  - `[set]`: Union of chars in `set`. Ranges `a-z`. `%x` classes allowed in `set`. `[^set]` complement.
  - `%` escapes magic chars: `^$()%.[]*+-?`.
- **Pattern Items:**
  - Class: Matches one char in class.
  - `class*`: 0+ repetitions (longest match).
  - `class+`: 1+ repetitions (longest match).
  - `class-`: 0+ repetitions (shortest match, non-greedy).
  - `class?`: 0 or 1 occurrence.
  - `%n`: Matches `n`-th captured string (1-9).
  - `%bxy`: Balanced match from `x` to `y` (e.g., `%b()` for balanced parentheses).
- **Pattern:** Sequence of pattern items. `^` anchors to start, `$` anchors to end (if at start/end of pattern).
- **Captures:** `(subpattern)` captures the matched substring. Numbered by opening parenthesis. `()` captures current position.
  _NumHi Relevance_: `[NUMHI]` Essential for `string.find, string.gmatch, string.gsub, string.match`. Used for parsing tags, extracting data from notes, validating input. `core.lua` uses `hl_group:match("_(%d+)$")` and `line:gmatch('#(%w+)')`.

### 5.5 Table Manipulation (`table` table)

Generic functions for table operations. Many assume array-like tables where "length" means `#table`.

| Function                                | Syntax / Parameters                                     | Description & Key Behavior                                                                                                                                                                          | Returns                                    | NumHi Relevance                                                                                                                                                                    |
| :-------------------------------------- | :------------------------------------------------------ | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `table.concat(tbl [, sep [, i [, j]]])` | `tbl`: table, `sep` (opt): string, `i,j` (opt): numbers | Concatenates `tbl[i]` to `tbl[j]` (strings/numbers) using `sep`. Default `sep="", i=1, j=#tbl`.                                                                                                     | Concatenated string.                       | `[NUMHI]` Efficiently joining list of strings (e.g., lines of a note for saving, parts of an exported document). `core.lua` uses it for status line parts and saving note content. |
| `table.foreach(tbl, f)`                 | `tbl`: table, `f`: function(k,v)                        | Calls `f(k,v)` for all elements in `tbl`. If `f` returns non-`nil`, loop breaks and `foreach` returns that value. Iteration order not guaranteed (like `pairs`). (Deprecated in later Lua versions) | Value from `f` if loop broken, else `nil`. | `[NUMHI]` Generic table traversal. `pairs` is often preferred.                                                                                                                     |
| `table.foreachi(tbl, f)`                | `tbl`: table, `f`: function(i,v)                        | Calls `f(i,v)` for numeric indices 1 to `#tbl`. If `f` returns non-`nil`, loop breaks and `foreachi` returns that value. (Deprecated in later Lua versions)                                         | Value from `f` if loop broken, else `nil`. | `[NUMHI]` Sequential array traversal. `ipairs` is often preferred.                                                                                                                 |
| `table.insert(tbl [, pos], val)`        | `tbl`: table, `pos` (opt): number, `val`: any           | Inserts `val` at `pos` (default `#tbl+1`), shifting elements up.                                                                                                                                    | (None)                                     | `[NUMHI]` Adding elements to lists (e.g., history stack, list of highlights/notes). `core.lua` uses it for history and status line parts.                                          |
| `table.maxn(tbl)`                       | `tbl`: table                                            | Returns largest positive numeric index. 0 if none. (Linear traversal).                                                                                                                              | Number.                                    | `[NUMHI]` Finding max index if `#tbl` is not reliable (e.g., sparse arrays).                                                                                                       |
| `table.remove(tbl [, pos])`             | `tbl`: table, `pos` (opt): number                       | Removes element at `pos` (default `#tbl`), shifts elements down.                                                                                                                                    | Removed element.                           | `[NUMHI]` Removing elements from lists (e.g., undo history, deleting a highlight/note from a list). `core.lua` uses it for history.                                                |
| `table.sort(tbl [, comp])`              | `tbl`: table, `comp` (opt): function(a,b) -> boolean    | Sorts `tbl` in-place from 1 to `#tbl`. `comp(a,b)` should return `true` if `a < b`. Default `comp` uses `<`. Not stable.                                                                            | (None)                                     | `[NUMHI]` Sorting highlights/notes for display or export (by position, creation time, tag). Need a custom `comp` function for complex sorting. The user desires reordering notes.  |

_(Note: `table.unpack` is `unpack` globally in Lua 5.1. `table.pack` is not in Lua 5.1.)_

### 5.6 Mathematical Functions (`math` table)

Interface to C math library. Angles in radians unless specified.

| Function                 | Syntax / Parameters       | Description & Key Behavior                                                                        | Returns             | NumHi Relevance                                                                                                              |
| :----------------------- | :------------------------ | :------------------------------------------------------------------------------------------------ | :------------------ | :--------------------------------------------------------------------------------------------------------------------------- |
| `math.abs(x)`            | `x`: number               | Absolute value of `x`.                                                                            | Number              | `[NUMHI]`                                                                                                                    |
| `math.acos(x)`           | `x`: number               | Arc cosine of `x`.                                                                                | Number (radians)    |                                                                                                                              |
| `math.asin(x)`           | `x`: number               | Arc sine of `x`.                                                                                  | Number (radians)    |                                                                                                                              |
| `math.atan(x)`           | `x`: number               | Arc tangent of `x`.                                                                               | Number (radians)    |                                                                                                                              |
| `math.atan2(y, x)`       | `y, x`: numbers           | Arc tangent of `y/x`, uses signs to find quadrant. Handles `x=0`. (Note order `y,x` vs C's `x,y`) | Number (radians)    |                                                                                                                              |
| `math.ceil(x)`           | `x`: number               | Smallest integer >= `x`.                                                                          | Number              | `[NUMHI]` UI calculations, rounding up.                                                                                      |
| `math.cos(x)`            | `x`: number (radians)     | Cosine of `x`.                                                                                    | Number              |                                                                                                                              |
| `math.cosh(x)`           | `x`: number               | Hyperbolic cosine of `x`.                                                                         | Number              |                                                                                                                              |
| `math.deg(x)`            | `x`: number (radians)     | Converts `x` to degrees.                                                                          | Number (degrees)    |                                                                                                                              |
| `math.exp(x)`            | `x`: number               | `e^x`.                                                                                            | Number              |                                                                                                                              |
| `math.floor(x)`          | `x`: number               | Largest integer <= `x`.                                                                           | Number              | `[NUMHI]` UI calculations, rounding down (e.g., `core.lua` uses it in `slot_to_color` and `contrast_fg` implicitly via `%`). |
| `math.fmod(x, y)`        | `x, y`: numbers           | Remainder of `x/y`. (Note: `x % y` in Lua is `x - floor(x/y)*y`)                                  | Number              | `[NUMHI]` For precise remainder calculations if Lua's `%` behavior (rounding quotient to -inf) is not desired.               |
| `math.frexp(x)`          | `x`: number               | `m, e` such that `x = m * 2^e`, `e` is int, `abs(m)` in `[0.5, 1)`.                               | `m`, `e`            |                                                                                                                              |
| `math.huge`              | (Constant)                | Value `HUGE_VAL` (infinity).                                                                      | Number              | `[NUMHI]` Representing infinity if needed for comparisons.                                                                   |
| `math.ldexp(m, e)`       | `m`: number, `e`: integer | `m * 2^e`.                                                                                        | Number              |                                                                                                                              |
| `math.log(x)`            | `x`: number               | Natural logarithm of `x`.                                                                         | Number              |                                                                                                                              |
| `math.log10(x)`          | `x`: number               | Base-10 logarithm of `x`.                                                                         | Number              |                                                                                                                              |
| `math.max(x, ...)`       | `x, ...`: numbers         | Maximum value among arguments.                                                                    | Number              | `[NUMHI]` Finding maximums for UI sizing, constraints. `core.lua` uses `math.max`.                                           |
| `math.min(x, ...)`       | `x, ...`: numbers         | Minimum value among arguments.                                                                    | Number              | `[NUMHI]` Finding minimums. `init.lua` uses `math.min` for `updatetime`. `core.lua` uses `math.min`.                         |
| `math.modf(x)`           | `x`: number               | Integral part of `x`, fractional part of `x`.                                                     | Int part, Frac part |                                                                                                                              |
| `math.pi`                | (Constant)                | Value of PI.                                                                                      | Number              |                                                                                                                              |
| `math.pow(x, y)`         | `x, y`: numbers           | `x^y` (same as `x^y` operator).                                                                   | Number              | `[NUMHI]`                                                                                                                    |
| `math.rad(x)`            | `x`: number (degrees)     | Converts `x` to radians.                                                                          | Number (radians)    |                                                                                                                              |
| `math.random([m [, n]])` | `m, n` (opt): integers    | No args: real in `[0,1)`. `m` arg: int in `[1,m]`. `m,n` args: int in `[m,n]`.                    | Number              | `[NUMHI]` Random selection if needed (e.g., random color from palette, though unlikely for NumHi).                           |
| `math.randomseed(x)`     | `x`: number               | Sets seed for `math.random`.                                                                      | (None)              |                                                                                                                              |
| `math.sin(x)`            | `x`: number (radians)     | Sine of `x`.                                                                                      | Number              |                                                                                                                              |
| `math.sinh(x)`           | `x`: number               | Hyperbolic sine of `x`.                                                                           | Number              |                                                                                                                              |
| `math.sqrt(x)`           | `x`: number               | Square root of `x` (same as `x^0.5`).                                                             | Number              |                                                                                                                              |
| `math.tan(x)`            | `x`: number (radians)     | Tangent of `x`.                                                                                   | Number              |                                                                                                                              |
| `math.tanh(x)`           | `x`: number               | Hyperbolic tangent of `x`.                                                                        | Number              |                                                                                                                              |

_(Note: The `luaref.md` provided has a numbering quirk, listing the next section also as 5.6. I will follow that numbering.)_

### 5.6 Input and Output Facilities (`io` table and file methods)

Two styles: implicit (default input/output files) and explicit (file handles).
All I/O functions return `nil` + error message on failure, else non-`nil` on success (unless stated).

**Implicit I/O (`io` table):**

| Function                     | Syntax / Parameters                          | Description & Key Behavior                                                                                                           | Returns                                                           | NumHi Relevance                                                                                                    |
| :--------------------------- | :------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------- |
| `io.close([file])`           | `file` (opt): file handle                    | Closes `file` or default output file. Equivalent to `file:close()`.                                                                  | `true` or `nil`, error message.                                   | `[NUMHI]` Closing files after reading/writing notes or config.                                                     |
| `io.flush()`                 |                                              | Flushes default output file. Equivalent to `io.output():flush()`.                                                                    | `true` or `nil`, error message.                                   | `[NUMHI]` Ensuring data is written to disk.                                                                        |
| `io.input([file])`           | `file` (opt): filename string or file handle | With filename: opens, sets as default input. With handle: sets as default input. No args: returns current default input.             | Current default input file handle (if no args).                   | `[NUMHI]` Less common for plugins; explicit file handling is safer.                                                |
| `io.lines([filename])`       | `filename` (opt): string                     | Iterator for lines in `filename` (or default input). Closes file on EOF if `filename` given.                                         | Iterator function.                                                | `[NUMHI]` Reading files line by line (e.g., config, notes data).                                                   |
| `io.open(filename [, mode])` | `filename`: string, `mode` (opt): string     | Opens file. Modes: "r" (read), "w" (write), "a" (append), "r+" (update), "w+" (update, erase), "a+" (append update). "b" for binary. | File handle or `nil`, error message.                              | `[NUMHI]` Core function for file operations: reading/writing JSON/YAML sidecar files for highlights and notes.     |
| `io.output([file])`          | `file` (opt): filename string or file handle | Similar to `io.input`, but for default output file.                                                                                  | Current default output file handle (if no args).                  | `[NUMHI]` Less common for plugins.                                                                                 |
| `io.popen(prog [, mode])`    | `prog`: string, `mode` (opt): "r" or "w"     | Starts program `prog`, returns handle to read from (`r`) or write to (`w`) its stdio. System dependent.                              | File handle or `nil`, error message.                              | `[NUMHI]` Interacting with external tools if needed for advanced features (e.g., PDF text extraction if possible). |
| `io.read(...)`               | `...`: format strings or number              | Reads from default input file using formats. See `file:read()`.                                                                      | String(s)/number(s) or `nil`.                                     | `[NUMHI]`                                                                                                          |
| `io.tmpfile()`               |                                              | Returns handle for temporary file (update mode, auto-removed on program end).                                                        | File handle or `nil`, error message.                              | `[NUMHI]` Creating temporary files for intermediate processing.                                                    |
| `io.type(obj)`               | `obj`: any value                             | Checks if `obj` is file handle.                                                                                                      | "file", "closed file", or `nil`.                                  | `[NUMHI]` Verifying file handles.                                                                                  |
| `io.write(...)`              | `...`: strings or numbers                    | Writes to default output file. See `file:write()`.                                                                                   | `true` or `nil`, error message (or file handle in some versions). | `[NUMHI]`                                                                                                          |

**Explicit I/O (File Handle Methods `file:`):**
Assume `file` is a handle from `io.open()` or `io.tmpfile()`.

| Method                           | Syntax / Parameters                                         | Description & Key Behavior                                                                                                   | Returns                                            | NumHi Relevance                                                                                                       |
| :------------------------------- | :---------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------- |
| `file:close()`                   |                                                             | Closes `file`.                                                                                                               | `true` or `nil`, error message.                    | `[NUMHI]` Essential: close files after use to save changes and free resources.                                        |
| `file:flush()`                   |                                                             | Saves any written data in `file`'s buffer to disk.                                                                           | `true` or `nil`, error message.                    | `[NUMHI]` Ensure data persistence before critical points or closing.                                                  |
| `file:lines()`                   |                                                             | Iterator for lines in `file`. Does NOT close file on EOF.                                                                    | Iterator function.                                 | `[NUMHI]` Reading lines from an already open file.                                                                    |
| `file:read(...)`                 | `...`: format strings or number                             | Reads from `file`. Formats: `"*n"` (number), `"*a"` (all from current pos), `"*l"` (next line, default), `number` (N bytes). | String(s)/number(s) or `nil` on EOF/error.         | `[NUMHI]` Reading content from highlight/note files. `"*a"` is good for reading whole JSON/Markdown.                  |
| `file:seek([whence [, offset]])` | `whence` (opt): "set", "cur", "end", `offset` (opt): number | Sets/gets file position. Default `whence="cur", offset=0` (gets current pos).                                                | New position or `nil`, error message.              | `[NUMHI]` File pointer manipulation if needed (e.g., for binary files or random access, less common for NumHi).       |
| `file:setvbuf(mode [, size])`    | `mode`: "no", "full", "line", `size` (opt): number          | Sets buffering mode for output file.                                                                                         | `true` or `nil`, error message.                    | `[NUMHI]` Fine-tuning performance for file writes, usually defaults are fine.                                         |
| `file:write(...)`                | `...`: strings or numbers                                   | Writes arguments to `file`.                                                                                                  | `file` handle on success, or `nil`, error message. | `[NUMHI]` Writing highlight/note data (e.g., JSON, Markdown) to files. The note persistence issue involved `buftype`. |

### 5.8 Operating System Facilities (`os` table)

Platform-dependent functions.

| Function                       | Syntax / Parameters                            | Description & Key Behavior                                                                                                                                                                    | Returns                                     | NumHi Relevance                                                                                                                                         |
| :----------------------------- | :--------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `os.clock()`                   |                                                | CPU time used by program in seconds (approx).                                                                                                                                                 | Number.                                     | `[NUMHI]` Profiling plugin performance.                                                                                                                 |
| `os.date([format [, time]])`   | `format` (opt): string, `time` (opt): number   | Formats `time` (default current) using `format`. `format="*t"`: returns table (year, month, day, etc.). `format` string: C `strftime` rules. `!format`: UTC. No args: locale-specific string. | String or Table.                            | `[NUMHI]` Timestamps for highlights/notes, logging.                                                                                                     |
| `os.difftime(t2, t1)`          | `t2, t1`: numbers (time values)                | Difference in seconds between `t1` and `t2`.                                                                                                                                                  | Number.                                     | `[NUMHI]` Calculating durations.                                                                                                                        |
| `os.execute([command])`        | `command` (opt): string                        | Passes `command` to OS shell. No `command`: returns non-zero if shell available.                                                                                                              | Status code (system-dependent), or boolean. | `[NUMHI]` Running external commands (e.g., for integration, git operations, opening files externally - use with caution).                               |
| `os.exit([code])`              | `code` (opt): number                           | Terminates host program (Neovim). Default `code` is success.                                                                                                                                  | (Does not return)                           | `[NUMHI]` **Avoid using in plugins**; can quit Neovim.                                                                                                  |
| `os.getenv(varname)`           | `varname`: string                              | Value of environment variable `varname`.                                                                                                                                                      | String or `nil`.                            | `[NUMHI]` Accessing environment variables for configuration (e.g., paths).                                                                              |
| `os.remove(filename)`          | `filename`: string                             | Deletes file.                                                                                                                                                                                 | `true` or `nil`, error message.             | `[NUMHI]` Deleting old/temporary highlight files.                                                                                                       |
| `os.rename(old, new)`          | `old, new`: strings (filenames)                | Renames file `old` to `new`.                                                                                                                                                                  | `true` or `nil`, error message.             | `[NUMHI]` Renaming highlight/note files if structure changes.                                                                                           |
| `os.setlocale(locale [, cat])` | `locale`: string, `cat` (opt): string          | Sets current locale. `cat`: "all", "collate", "ctype", "monetary", "numeric", "time".                                                                                                         | Locale string or `nil`.                     | `[NUMHI]` Affects string comparisons, date formatting. Usually not changed by plugins.                                                                  |
| `os.time([table])`             | `table` (opt): date fields (year, month, etc.) | No args: current time as number. With `table`: converts table to time number. Meaning of number is system-dependent (usually seconds since epoch).                                            | Number (time value).                        | `[NUMHI]` Getting current time for timestamps.                                                                                                          |
| `os.tmpname()`                 |                                                | Returns unique temporary filename string. File must be explicitly opened/removed.                                                                                                             | String.                                     | `[NUMHI]` Creating temporary files if `io.tmpfile()` is not suitable (e.g., if name needed before opening or for external tools). Needs manual cleanup. |

### 5.9 The Debug Library (`debug` table)

Interface to Lua's debug facilities. Use with care: can be slow and compromise security. Optional first arg to functions is thread (default current).

| Function                                       | Syntax / Parameters                                                  | Description & Key Behavior                                                                                                                                                                                                | Returns                           | NumHi Relevance                                                                                                                                                                                                          |
| :--------------------------------------------- | :------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :-------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `debug.debug()`                                |                                                                      | Enters interactive debug mode (reads commands from stdin). `cont` to exit.                                                                                                                                                | (None)                            | `[NUMHI]` For interactive debugging during development.                                                                                                                                                                  |
| `debug.getfenv(o)`                             | `o`: any object                                                      | Returns environment of `o`.                                                                                                                                                                                               | Environment table.                | `[NUMHI]` Inspecting environments (rare).                                                                                                                                                                                |
| `debug.gethook([thread])`                      | `thread` (opt)                                                       | Gets current hook function, mask, count.                                                                                                                                                                                  | `hook_func, mask_str, count_num`. | `[NUMHI]` Inspecting hooks.                                                                                                                                                                                              |
| `debug.getinfo([thr,] func [, what])`          | `thr` (opt), `func`: function or stack level, `what` (opt): string   | Returns table with info about `func` or stack `level`. `what` string: 'n' (name), 'S' (source/lines), 'l' (currentline), 'u' (nups), 'f' (pushes func), 'L' (pushes valid lines table). Default `what` is all except 'L'. | Info table or `nil`.              | `[NUMHI]` Essential for tracebacks, inspecting call stack, getting function source info. `luaL_where` is built on this.                                                                                                  |
| `debug.getlocal([thr,] level, local_idx)`      | `thr` (opt), `level`: number, `local_idx`: number                    | Returns name and value of local variable `local_idx` at `level`. Index 1 is first param/local. Names like `(*)` are internal.                                                                                             | `name_str, value` or `nil`.       | `[NUMHI]` Inspecting local variables during debugging.                                                                                                                                                                   |
| `debug.getmetatable(obj)`                      | `obj`: any value                                                     | Returns metatable of `obj` (even if `__metatable` field exists).                                                                                                                                                          | Metatable or `nil`.               | `[NUMHI]` Inspecting "true" metatables.                                                                                                                                                                                  |
| `debug.getregistry()`                          |                                                                      | Returns the registry table.                                                                                                                                                                                               | Registry table.                   | `[NUMHI]` Inspecting Lua registry (advanced debugging).                                                                                                                                                                  |
| `debug.getupvalue(func, up_idx)`               | `func`: function, `up_idx`: number                                   | Returns name and value of upvalue `up_idx` of `func`.                                                                                                                                                                     | `name_str, value` or `nil`.       | `[NUMHI]` Inspecting closure upvalues.                                                                                                                                                                                   |
| `debug.setfenv(obj, table)`                    | `obj`: any object, `table`: environment table                        | Sets environment of `obj` to `table`.                                                                                                                                                                                     | `obj`.                            | `[NUMHI]` Modifying environments (rare, use with caution).                                                                                                                                                               |
| `debug.sethook([thr,] hook, mask [, count])`   | `thr` (opt), `hook`: function, `mask`: string, `count` (opt): number | Sets debug hook. `mask`: "c"(call), "r"(return), "l"(line). `count`: hook after N instructions. Empty args turns off hook. Hook gets event string ("call", "return", "line", "count") and context.                        | (None)                            | `[NUMHI]` Profiling, tracing execution flow.                                                                                                                                                                             |
| `debug.setlocal([thr,] level, local_idx, val)` | `thr` (opt), `level, local_idx`: numbers, `val`: any                 | Assigns `val` to local variable `local_idx` at `level`.                                                                                                                                                                   | `name_str` or `nil`.              | `[NUMHI]` Modifying local variables during debugging.                                                                                                                                                                    |
| `debug.setmetatable(obj, table)`               | `obj`: any value, `table`: metatable or `nil`                        | Sets metatable for `obj` (can change for any type here).                                                                                                                                                                  | `obj`.                            | `[NUMHI]` Modifying metatables, even for types like strings/numbers (use with extreme caution).                                                                                                                          |
| `debug.setupvalue(func, up_idx, val)`          | `func`: function, `up_idx`: number, `val`: any                       | Assigns `val` to upvalue `up_idx` of `func`.                                                                                                                                                                              | `name_str` or `nil`.              | `[NUMHI]` Modifying closure upvalues.                                                                                                                                                                                    |
| `debug.traceback([thr,] [msg [, level]])`      | `thr` (opt), `msg` (opt): string, `level` (opt): number              | Returns string with call stack traceback. `msg` prepended. `level` is start level (default 1).                                                                                                                            | Traceback string.                 | `[NUMHI]` Generating stack traces for error reporting. Often used in custom `pcall` error handlers. This is very relevant for robust error messages in NumHi, especially for the note saving/reopening issues mentioned. |

---
